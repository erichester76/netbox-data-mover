{% extends 'generic/object_edit.html' %}
{% load static %}
{% load buttons %}
{% load helpers %}
{% load plugins %}

{% block content %}
<form id="job-editor-form">
    {% csrf_token %}
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="name" class="form-label">Name</label>
            {{ form.name }}
        </div>
        <div class="col-md-6">
            <label for="schedule" class="form-label">Schedule</label>
            {{ form.schedule }}
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-12">
            <label for="description" class="form-label">Description</label>
            {{ form.description }}
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="source" class="form-label">Source</label>
            {{ form.source }}
        </div>
        <div class="col-md-6">
            <label for="source-endpoint" class="form-label">Source Endpoint</label>
            {{ form.source_endpoint }}
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="destination" class="form-label">Destination</label>
            {{ form.destination }}
        </div>
        <div class="col-md-6">
            <label for="destination-endpoint" class="form-label">Destination Endpoint</label>
            {{ form.destination_endpoint }}
        </div>
    </div>
    <h4>Field Mappings</h4>
    <div id="mappings-container" class="mb-3"></div>
    <div class="d-flex justify-content-between mt-3">
        <button type="button" id="add-mapping" class="btn btn-secondary">Add Field Mapping</button>
        <button type="submit" class="btn btn-primary">Save Job</button>
    </div>
</form>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.20.0/cytoscape.min.js"></script>
<script>
    var sourceFields = {};
    var destinationFields = {};

    $(function() {
        console.log("Window loaded");
        
        // Update fields when source or destination changes
        $(document).on('change', '#source, #source-endpoint', function() {
            let endpoint = $('source-endpoint').val();
            if (endpoint) {
                let id = $('#source').val();
                if (id) {
                getFields(id, endpoint, true);
                }        
            }
        });

        // Update fields when source or destination changes
        $(document).on('change', '#destination, #destination-endpoint', function() {
            let endpoint = $('destination-endpoint').val();
            if (endpoint) {
                let id = $('#destination').val();
                if (id) {
                getFields(id, endpoint, true);
                }        
            }
        });

});

    // Fetch fields once and store globally
    function getFields(datasourceId, endpoint, isSource) {
        console.log(`Getting fields for datasource ID: ${datasourceId} and endpoint: ${endpoint}`);
        $.ajax({
            url: `/api/plugins/netbox_data_mover/datasources/${datasourceId}/get_fields/${endpoint}/`,
            method: 'GET',
            success: function(data) {
                if (isSource) {
                    sourceFields = data.fields;  // Store source fields globally
                } else {
                    destinationFields = data.fields;  // Store destination fields globally
                }

                // Update all existing mapping lines
                $('.mapping-line').each(function() {
                    let sourceFieldSelect = $(this).find('.source-field');
                    let destinationFieldSelect = $(this).find('.destination-field');

                    if (isSource) {
                        populateFields(sourceFieldSelect, sourceFields);
                    } else {
                        populateFields(destinationFieldSelect, destinationFields);
                    }
                });
                console.log("Fields updated for all existing mapping lines");
            },
            error: function(error) {
                console.error("Failed to get fields", error);
            }
        });
    }

    // Helper function to populate fields into a select element
    function populateFields(selectElement, fields) {
        selectElement.empty();
        selectElement.append('<option value="">Select Field</option>');
        $.each(fields, function(index, field) {
            selectElement.append(`<option value="${field}">${field}</option>`);
        });
    }

    // Add mapping line functionality
    $(document).on('click', '#add-mapping', function() {
        let mappingLineHtml = `    
            <div class="row mb-3 mapping-line">
                <div class="col-md-3">
                    {{ form.source_mapping }}
                </div>
                <div class="col-md-3">
                    {{ form.destination_mapping }}
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-secondary add-transform">Add Transform</button>
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-danger remove-mapping" style="background: none; border: none;">X</button>
                </div>
            </div>
            <div class="transform-container"></div>`;

        $('#mappings-container').append(mappingLineHtml);
        let newMappingLine = $('#mappings-container').children('.mapping-line').last();

        // Populate the fields for the new mapping line with stored values
        populateFields(newMappingLine.find('.source-field'), sourceFields);
        populateFields(newMappingLine.find('.destination-field'), destinationFields);
    }); 

    // Add transform line functionality
    $(document).on('click', '.add-transform', function() {
        let transformHtml = `
            <div class="row mb-3 transform-line">
                <div class="col-md-4 offset-md-1">
                    <select class="form-select transform-type">
                        <option value="">Select Transform</option>
                        <option value="upper">Upper</option>
                        <option value="lower">Lower</option>
                        <option value="title">Title</option>
                        <option value="replace">Replace</option>
                        <option value="replace_map">Replace Map</option>
                        <option value="lookup_id">Lookup Object</option>
                        <option value="nested_item">Lookup Object</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control transform-param" placeholder="Transform Parameter 1">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control transform-param" placeholder="Transform Parameter 2">
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-danger remove-transform" style="background: none; border: none;">X</button>
                </div>
            </div>`;

        $(this).closest('.mapping-line').next('.transform-container').append(transformHtml);
    });

    // Remove mapping line functionality
    $(document).on('click', '.remove-mapping', function() {
                $(this).closest('.mapping-line').next('.transform-container').remove();
                $(this).closest('.mapping-line').remove();
                updateDiagramFromForm();
    });

    // Remove transform line functionality
    $(document).on('click', '.remove-transform', function() {
        $(this).closest('.transform-line').remove();
        updateDiagramFromForm();
    });

    // Form submit handler
    $(document).on('submit', '#job-editor-form', function(event) {
        event.preventDefault();
        saveJobConfiguration();
    });

    </script>
{% endblock %}