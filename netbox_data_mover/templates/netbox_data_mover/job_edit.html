{% extends 'generic/object_edit.html' %}
{% load static %}
{% load buttons %}
{% load helpers %}
{% load plugins %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Job Editor</h2>
                </div>
                <div class="card-body">
                    <form id="job-editor-form">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="source" class="form-label">Source</label>
                                <select id="source" class="form-select" required>
                                    <option value="">Select Source</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="source-endpoint" class="form-label">Source Endpoint</label>
                                <input type="text" id="source-endpoint" class="form-control" placeholder="Enter Source Endpoint" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="destination" class="form-label">Destination</label>
                                <select id="destination" class="form-select" required>
                                    <option value="">Select Destination</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="destination-endpoint" class="form-label">Destination Endpoint</label>
                                <input type="text" id="destination-endpoint" class="form-control" placeholder="Enter Destination Endpoint" required>
                            </div>
                        </div>

                        <h4>Field Mappings</h4>
                        <div id="mappings-container" class="mb-3"></div>
                        <div class="d-flex justify-content-between mt-3">
                            <button type="button" id="add-mapping" class="btn btn-secondary">Add Field Mapping</button>
                            <button type="submit" class="btn btn-primary">Save Job</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-5">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Mapping Diagram</h4>
                </div>
                <div class="card-body">
                    <div id="cy" style="width: 100%; height: 400px; border: 1px solid #ccc;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.20.0/cytoscape.min.js"></script>
<script>
   $(window).on('load', function() {
    console.log("Window loaded, calling populateSourcesAndDestinations");
    populateSourcesAndDestinations();

    // Add mapping line functionality
    $(document).on('click', '#add-mapping', function() {
        addMappingLine();
    });

    // Form submit handler
    $(document).on('submit', '#job-editor-form', function(event) {
        event.preventDefault();
        saveJobConfiguration();
    });

    // Trigger get_fields when the source or destination changes
    $(document).on('change', '#source, #destination', function() {
        let datasourceId = $(this).val();
        if (datasourceId) {
            get_fields(datasourceId, $(this).attr('id'));
        }
    });

    // Initialize Cytoscape diagram
    var cy = cytoscape({
        container: document.getElementById('cy'),
        elements: [],
        style: [
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'text-valign': 'center',
                    'color': '#000',
                    'background-color': '#007bff',
                    'width': 'label',
                    'height': 30
                }
            },
            {
                selector: 'edge',
                style: {
                    'curve-style': 'bezier',
                    'width': 3,
                    'line-color': '#9dbaea',
                    'target-arrow-color': '#9dbaea',
                    'target-arrow-shape': 'triangle',
                    'label': 'data(transform)'
                }
            }
        ]
    });


function populateSourcesAndDestinations() {
    console.log("Calling API to populate sources and destinations...");
    $.ajax({
        url: '/api/plugins/datamover/datasources',
        method: 'GET',
        success: function(data) {
            let selectSource = document.getElementById('source');
            let selectDestination = document.getElementById('destination');

            data.forEach((datasource) => {
                let option = document.createElement('option');
                option.value = datasource.id;
                option.text = `${datasource.name} (${datasource.type})`;
                selectSource.add(option);

                let destinationOption = document.createElement('option');
                destinationOption.value = datasource.id;
                destinationOption.text = `${datasource.name} (${datasource.type})`;
                selectDestination.add(destinationOption);
            });
        },
        error: function(error) {
            console.error("Failed to load sources and destinations", error);
        }
    });
}

function get_fields(datasourceId, selectId) {
    console.log(`Getting Fields for datasource ID: ${datasourceId}`);
    $.ajax({
        url: `/api/plugins/datamover/datasource/get_fields?datasource_id=${datasourceId}`,
        method: 'GET',
        success: function(moduleData) {
            let select = $(`#${selectId}-endpoint`);
            select.empty().append('<option value="">Select Field</option>');
            moduleData.fields.forEach(function(field) {
                select.append(`<option value="${field}">${field}</option>`);
            });
        },
        error: function(error) {
            console.error("Failed to iget fields for datasource", error);
        }
    });
}


    function addMappingLine() {
        let mappingLineHtml = `
            <div class="row mb-3 mapping-line">
                <div class="col-md-3">
                    <input type="text" class="form-control source-field" placeholder="Source Field">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control destination-field" placeholder="Destination Field">
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-secondary add-transform">Add Transform</button>
                </div>
            </div>
            <div class="transform-container"></div>
        `;
        $('#mappings-container').append(mappingLineHtml);
        updateDiagramFromForm();
    }

    // Add transform line functionality
    $(document).on('click', '.add-transform', function() {
        let transformHtml = `
            <div class="row mb-3 transform-line">
                <div class="col-md-4 offset-md-1">
                    <select class="form-select transform-type">
                        <option value="">Select Transform</option>
                        <option value="replace">Replace</option>
                        <option value="replace_map">Replace Map</option>
                        <option value="lookup_object">Lookup Object</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control transform-param" placeholder="Transform Parameters">
                </div>
            </div>
        `;
        $(this).closest('.mapping-line').next('.transform-container').append(transformHtml);
    });

    function updateDiagramFromForm() {
        let nodes = [];
        let edges = [];

        let source = $('#source option:selected').text();
        let destination = $('#destination option:selected').text();

        if (source) {
            nodes.push({ data: { id: 'source', label: source } });
        }

        if (destination) {
            nodes.push({ data: { id: 'destination', label: destination } });
        }

        $('.mapping-line').each(function(index, line) {
            let sourceField = $(line).find('.source-field').val();
            let destinationField = $(line).find('.destination-field').val();
            let transform = $(line).find('.transform-type').val();

            if (sourceField && destinationField) {
                nodes.push({ data: { id: `source-${index}`, label: sourceField } });
                nodes.push({ data: { id: `destination-${index}`, label: destinationField } });
                edges.push({ data: { source: `source-${index}`, target: `destination-${index}`, transform: transform } });
            }
        });

        cy.elements().remove();
        cy.add(nodes);
        cy.add(edges);
        cy.layout({ name: 'breadthfirst' }).run();
    }

    function saveJobConfiguration() {
        let jobData = {
            source: $('#source').val(),
            source_endpoint: $('#source-endpoint').val(),
            destination: $('#destination').val(),
            destination_endpoint: $('#destination-endpoint').val(),
            mappings: []
        };

        $('.mapping-line').each(function(index, line) {
            let mapping = {
                source: $(line).find('.source-field').val(),
                destination: $(line).find('.destination-field').val(),
                transforms: []
            };
            $(line).next('.transform-container').find('.transform-line').each(function(i, transformLine) {
                let transform = {
                    type: $(transformLine).find('.transform-type').val(),
                    params: $(transformLine).find('.transform-param').val()
                };
                mapping.transforms.push(transform);
            });
            jobData.mappings.push(mapping);
        });

        console.log('Job Data:', jobData);
        // AJAX POST to save the job configuration here...
    }
   });
</script>
{% endblock %}